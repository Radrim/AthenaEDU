@page "/"

@using System.ComponentModel.DataAnnotations;
@inject CourseService courseService
@inject CategoryService categoryService

<MudGrid Justify="Justify.Center" Style="width: 100%; height: 100%;">
    <MudPaper Elevation="5" Width="70%">
        <MudGrid Justify="Justify.SpaceAround" Style="display: flex; align-items: center;" Class="mt-5">
            <MudItem xs="6" md="6">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="searchText" Label="Поиск" Variant="Variant.Outlined" Class="mud-textfield-search" Adornment="Adornment.Start"> </MudTextField>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PerformSearch">Искать</MudButton>
                </MudStack>
            </MudItem>
            <MudItem xs="4" md="4">
                <MudSelect T="string" @bind-Value="selectedCategory" For="@(() => selectedCategory)" Label="Фильтрация по категории:" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.BottomRight"
                           Variant="Variant.Filled" AdornmentColor="Color.Primary" Class="mud-theme-secondary">
                    @foreach (var item in courseCategories)
                    {
                        <MudSelectItem Value="@item.Name">@item.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>

        <MudGrid Justify="Justify.SpaceEvenly" Style="display: flex; align-items: center;" Class="mt-5">
            @foreach (var item in Courses)
            {
                <MudItem xs="12" md="12">
                    <MudPaper Class="mr-5 ml-5" Elevation="2">
                        <MudStack Row="true">
                            <MudImage Src="/images/defaultCourseImage.jpg" Width="200" Height="200" ObjectFit="ObjectFit.Cover"></MudImage>
                            <MudStack Class="mr-2 ml-2 mt-2">
                                <MudText Typo="Typo.h5" Style="font-weight: bold">@item.Name</MudText>
                                <MudStack Row="true">
                                    <MudText Typo="Typo.h6">Автор: @item.Author</MudText>
                                    @* <MudText Typo="Typo.h6">Категория: @item.Category.Name</MudText> *@
                                </MudStack>
                                <MudText Typo="Typo.h5">@item.Description</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>
</MudGrid>

@code {
    List<Course> Courses = new List<Course>();
    private string selectedCategory;
    List<CourseCategory> courseCategories = new List<CourseCategory>();
    private string searchText;

    private async Task PerformSearch()
    {
        if (!String.IsNullOrEmpty(searchText))
        {
            Courses = await courseService.FindBySearchCourses(searchText);
        }

        else
        {
            Courses = await FillCourses();    
        }

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        courseCategories = await categoryService.GetAllCategoriesAsync();
        Courses = await FillCourses();
    }

    private async Task<List<Course>> FillCourses()
    {
        return await courseService.GetAllCourses();
    }
}
